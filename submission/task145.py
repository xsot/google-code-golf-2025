p=lambda x,k=7,v=1:-k*x or p([[a:=b&2or[b//max(f:=sum(x,[]))+(min({*f}-{2})==b)*8,b%511*4,*[a&~2|b]*5,v:=v*512][k]for b in[2]+r][:0:-1]for*r,in zip(*x)],k-1)