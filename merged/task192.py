# att (114 bytes, gold)
b=c='for*d,c,b,a in zip(b,c,z+a,a[1:]+z,a)]'
*z,p=b,lambda a:eval('[[[sum({*d}&{b,c}),a][f"{a}, "*2in"%s"]'%a+b*2)

##
b,=c,=z=['for*d,c,b,a in zip(b,c,z+a,a[1:]+z,a)]']
p=lambda a:eval('[[[sum({*d}&{b,c}),a][%s.count(a)>30]'%sum(a,a)+b*2)

### joking (tied, 114 bytes)
b=c='[[[sum({*d}&{b,c}),a][f"{a}, "*2in"%s"]'+'for*d,c,b,a in zip(b,c,z+a,a[1:]+z,a)]'*2;*z,p=b,lambda a:eval(b%a)

##
*z,p='for a,*d in zip(a,a[1:]+z,z+a,*d)]',lambda a,*d:eval('[[[sum({*d[2:]}&{*d[:2]}),a][f"{a}, "*2in"%s"]'%a+z[0]*2)
*z,p='_'*99,lambda a,r=[],*d:a*0!=0and[*map(p,a,[r+a]*99,a[1:]+z,z+a,*d)]or[sum({*d[2:]}&{*d[:2]}),a][f"{a}, "*2in"%s"%r]
p=lambda a,r="_"*99,*d:a*0!=0and[*map(p,a,[r+str(a)]*99,a[1:]+[r],[r]+a,*d)]or[sum({*d[2:]}&{*d[:2]}),a][f"{a}, "*2in r]

### ovs (115 bytes)
b,=c,=z=['for*d,c,b,a in zip(b,c,z+a,a[1:]+z,a)]']
p=lambda a:eval('[[[sum({*d}&{b,c}),a][f"{a}, "*2in"%s"]'%a+b*2)

### combined (155 bytes)
p=lambda i,u=[[0]*99]:[[[max(t)*(2*f"{max(t)}, "in str(t*2)),k][sum(i,i).count(k)>30]for*t,k in zip(m,[0]+l,n,l[1:]+[0],l)]for l,m,n in zip(i,u+i,i[1:]+u)]
