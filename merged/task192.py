# att (120 vs 2500 bytes for gold)
b,=c,=z=['for*d,c,b,a in zip(b,c,z+a,a[1:]+z,a)]']
p=lambda a:eval('[[[sum({*d}&{b,c}),a][%s.count(a)>30]'%sum(a,a)+b*2)

##

z=[" "*20]
p=lambda a:[[[sum({*e}&{f,g}),h][sum(a,a).count(h)>30]for*e,f,g,h in zip(b,d,z+c,c[1:]+z,c)]for b,c,d in zip(z+a,a,a[1:]+z)]

### combined (155 bytes)
p=lambda i,u=[[0]*99]:[[[max(t)*(2*f"{max(t)}, "in str(t*2)),k][sum(i,i).count(k)>30]for*t,k in zip(m,[0]+l,n,l[1:]+[0],l)]for l,m,n in zip(i,u+i,i[1:]+u)]
